{% extends "auctions/layout.html" %}
{% load static %}
{% load humanize %}  <!-- This allows the commas in the bids -->

{% block body %}

<div>
    {% if user.is_authenticated %}
        {% if in_watchlist %}
            <a href="{% url 'remove_from_watchlist' listing.id %}" class="watchlist">Remove from Watchlist</a>
        {% else %}
            <a href="{% url 'add_to_watchlist' listing.id %}" class="watchlist">Add to Watchlist</a> 
        {% endif %}
        {% if user == listing.User and listing.status == "Active" %}
            <a href="{% url 'close_listing' listing.id %}"  class="close-listing">Close Listing</a>
        {% endif %}
    {% endif %}
</div>

<div class="listing-page-grid">
  <div class="listing-details">
    <div class="details-grid">
        <img src="{{ listing.url_image }}" alt="Image of Listing" style="max-width:300px; width:100%; margin:1rem 0;">
        <div class="details-info">
            <h1>{{ listing.title }}</h1>
            <div class="spacer">
                <span class="category">{{ listing.category }}</span>
            </div>
            <p class="price">
                {% if listing.current_price %}
                    <strong>Current Highest Bid:</strong> ${{ listing.current_price|floatformat:2|intcomma }}
                {% else %}
                    <strong>No bids yet</strong>
                {% endif %}
            </p>
            <p class="description">{{ listing.description }}</p>
        </div>
    </div>
  </div>
  
  <div class="listing-bids">

    {% if listing.status == "Closed" %}
        <div class="closed-message">
            <strong>This listing is closed. No further bids are accepted.</strong>
            <div class="winner-label">
                Winner: {{ winner.username }}
            </div>
        </div>
    {% else %}
        <div class="spacer">
            <h2>Place a Bid</h2>
        </div>
        
        {% if error %}
        <div class="error-message">{{ error }}</div>
        {% endif %}

        <form action="{% url 'bid' listing.id %}" method="post">
        {% csrf_token %}
        {{ form }}
        <button type="submit">Place Bid</button>
        </form>
    {% endif %}

    <br>

    <div class="spacer">
        <h3>Bid History</h3>
    </div>

    <ul class="bid-history">
      {% for bid in bids %}
        <li>
          ${{ bid.price|floatformat:2|intcomma }} by {{ bid.User.username }} on {{ bid.datetime|date:"M d, Y H:i" }}
        </li>
      {% empty %}
        <li>No bids yet.</li>
      {% endfor %}
    </ul>
  </div>

</div>

<div class="comments-section">
    <div class="spacer">
        <h2>Comments</h2>
    </div>
    {% if user.is_authenticated %}
        <form action="{% url 'add_comment' listing.id %}" method="post">
            {% csrf_token %}
            {{ comment_form }}
            <button type="submit">Add Comment</button>
        </form>
    {% else %}
        <p><a href="{% url 'login' %}">Log in</a> to add a comment.</p>
    {% endif %}
    
    <hr>
    
    <ul class="comment-list">
        {% for comment in comments %}
            <li>
                <strong>{{ comment.User.username }}</strong> on {{ comment.datetime|date:"M d, Y H:i" }}:<br>
                {{ comment.comment }}
            </li>
        {% empty %}
            <li>No comments yet.</li>
        {% endfor %}
    </ul>
</div>

    <a href="{% url 'index' %}">Back to All Listings</a>
{% endblock %}